#!/bin/bash

CONFIG="/etc/boghche/config.json"

title() {
  gum style \
    --foreground 212 \
    --border-foreground 212 \
    --border double \
    --align center \
    --width 50 \
    "ðŸŒ¿ Boghche Gateway"
}

configure() {
  PUB_IP=$(gum input --placeholder "Server Public IP")
  FGT_IP=$(gum input --placeholder "Remote Peer IP")
  WAN_IF=$(gum input --value "eth0" --placeholder "WAN Interface")
  VTI_ADDR=$(gum input --placeholder "Tunnel IP (10.11.11.2/30)")

  mkdir -p /etc/boghche

  cat > $CONFIG <<EOF
{
  "pub_ip": "$PUB_IP",
  "fgt_ip": "$FGT_IP",
  "wan_if": "$WAN_IF",
  "vti_addr": "$VTI_ADDR"
}
EOF

  gum style --foreground 10 "âœ” Configuration Saved"
}

while true; do
  clear
  title

  CHOICE=$(gum choose \
    "Configure Tunnel" \
    "Start Tunnel" \
    "Stop Tunnel" \
    "Service Status" \
    "View Config" \
    "Exit")

  case "$CHOICE" in
    "Configure Tunnel")
      configure
      ;;
    "Start Tunnel")
      systemctl restart boghche
      gum style --foreground 10 "âœ” Tunnel Started"
      ;;
    "Stop Tunnel")
      systemctl stop boghche
      gum style --foreground 1 "âœ– Tunnel Stopped"
      ;;
    "Service Status")
      STATUS=$(systemctl is-active boghche)
      gum style --foreground 14 "Status: $STATUS"
      ;;
    "View Config")
      if [ -f "$CONFIG" ]; then
        cat $CONFIG | gum format
      else
        gum style --foreground 1 "No config found."
      fi
      ;;
    "Exit")
      exit
      ;;
  esac

  gum confirm "Return to menu?" || exit
done
